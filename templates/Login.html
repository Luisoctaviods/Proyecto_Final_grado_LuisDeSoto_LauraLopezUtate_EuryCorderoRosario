{% extends "base.html" %}

{% block title %}inchat - Iniciar Sesión{% endblock %}

{% block content %}
<div class="container">
    <div class="auth-card">
        <div class="logo">
            <h1>inchat</h1>
        </div>
        
        <div class="welcome-text">
            <h2>Bienvenido</h2>
            <p>Accede a tu cuenta o crea una nueva</p>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('login')">Iniciar Sesión</button>
            <button class="tab-button" onclick="switchTab('register')">Registrarse</button>
        </div>

        <!-- Formulario de Login -->
        <form id="loginForm" class="auth-form">
            <div class="form-group">
                <label for="loginEmail">Correo electrónico</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="tu@ejemplo.com" required>
            </div>

            <div class="form-group">
                <label for="loginPassword">Contraseña</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="••••••••" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="remember" name="remember">
                <label for="remember">Recordarme</label>
            </div>

            <div class="forgot-password">
                <a href="#" onclick="showForgotPassword()">¿Olvidaste tu contraseña?</a>
            </div>

            <button type="submit" class="btn" id="loginBtn">
                <span class="btn-text">Iniciar Sesión</span>
                <div class="loading" style="display: none;"></div>
            </button>
        </form>

        <!-- Formulario de Registro -->
        <form id="registerForm" class="auth-form" style="display: none;">
            <div class="form-group">
                <label for="registerName">Nombre completo</label>
                <input type="text" id="registerName" class="form-control" placeholder="Tu nombre" required>
            </div>

            <div class="form-group">
                <label for="registerEmail">Correo electrónico</label>
                <input type="email" id="registerEmail" class="form-control" placeholder="tu@ejemplo.com" required>
            </div>

            <div class="form-group">
                <label for="registerPassword">Contraseña</label>
                <input type="password" id="registerPassword" class="form-control" placeholder="••••••••" required>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirmar contraseña</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="••••••••" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="acceptTerms" name="acceptTerms" required>
                <label for="acceptTerms">Acepto los <a href="#" target="_blank">términos y condiciones</a></label>
            </div>

            <button type="submit" class="btn" id="registerBtn">
                <span class="btn-text">Crear Cuenta</span>
                <div class="loading" style="display: none;"></div>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTab = 'login';

function switchTab(tab) {
    currentTab = tab;
    
    // Actualizar botones
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Mostrar/ocultar formularios
    if (tab === 'login') {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
    } else {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    }
    
    // Limpiar mensajes de error
    const messages = document.querySelectorAll('.error-message, .success-message');
    messages.forEach(msg => msg.remove());
}

function showLoading(formType) {
    const btn = document.getElementById(formType + 'Btn');
    const btnText = btn.querySelector('.btn-text');
    const loading = btn.querySelector('.loading');
    
    btn.disabled = true;
    btnText.style.display = 'none';
    loading.style.display = 'block';
}

function hideLoading(formType) {
    const btn = document.getElementById(formType + 'Btn');
    const btnText = btn.querySelector('.btn-text');
    const loading = btn.querySelector('.loading');
    
    btn.disabled = false;
    btnText.style.display = 'block';
    loading.style.display = 'none';
}

function showForgotPassword() {
    alert('Funcionalidad de recuperación de contraseña próximamente disponible.');
}

function validatePasswords() {
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (password !== confirmPassword) {
        showMessage('Las contraseñas no coinciden', 'error');
        return false;
    }
    
    if (password.length < 6) {
        showMessage('La contraseña debe tener al menos 6 caracteres', 'error');
        return false;
    }
    
    return true;
}

// Manejar formulario de login
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showMessage('Por favor completa todos los campos', 'error');
        return;
    }
    
    showLoading('login');
    
    try {
        const response = await fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('Iniciando sesión...', 'success');
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1000);
        } else {
            showMessage(data.message || 'Error al iniciar sesión', 'error');
        }
    } catch (error) {
        showMessage('Error de conexión. Intenta nuevamente.', 'error');
    }
    
    hideLoading('login');
});

// Manejar formulario de registro
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const acceptTerms = document.getElementById('acceptTerms').checked;
    
    if (!name || !email || !password) {
        showMessage('Por favor completa todos los campos', 'error');
        return;
    }
    
    if (!acceptTerms) {
        showMessage('Debes aceptar los términos y condiciones', 'error');
        return;
    }
    
    if (!validatePasswords()) {
        return;
    }
    
    showLoading('register');
    
    try {
        const response = await fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                nombre_completo: name,
                email: email,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('Cuenta creada exitosamente. Ahora puedes iniciar sesión.', 'success');
            setTimeout(() => {
                switchTab('login');
                // Limpiar formulario
                document.getElementById('registerForm').reset();
            }, 2000);
        } else {
            showMessage(data.message || 'Error al crear la cuenta', 'error');
        }
    } catch (error) {
        showMessage('Error de conexión. Intenta nuevamente.', 'error');
    }
    
    hideLoading('register');
});

// Validación en tiempo real de contraseñas
document.getElementById('confirmPassword').addEventListener('input', function() {
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && password !== confirmPassword) {
        this.style.borderColor = '#ff3333';
    } else {
        this.style.borderColor = '#4a4a4a';
    }
});
</script>
{% endblock %}